<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CognitiveBiasGauge - Анализатор когнитивных искажений</title>
    <meta name="description" content="SPA для анализа мыслей на когнитивные искажения с использованием AI">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS через CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .thought-input {
            min-height: 120px;
            resize: vertical;
        }
        .loading-bar {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        [x-cloak] { display: none !important; }
        
        /* Стили для скроллбара */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">
    <!-- Alpine.js Component Container -->
    <div x-data="cognitiveBiasApp" x-init="init()" class="min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <h1 class="text-3xl font-bold">
                            <i class="fas fa-brain mr-3"></i>CognitiveBiasGauge
                        </h1>
                        <p class="text-primary-100 mt-2">Анализатор когнитивных искажений на основе AI</p>
                    </div>
                    <div class="flex space-x-4">
                        <button @click="activeTab = 'analyze'" 
                                :class="activeTab === 'analyze' ? 'bg-white text-blue-700' : 'bg-blue-700 text-white'"
                                class="px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-search mr-2"></i>Анализ
                        </button>
                        <button @click="activeTab = 'history'"
                                :class="activeTab === 'history' ? 'bg-white text-blue-700' : 'bg-blue-700 text-white'"
                                class="px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-history mr-2"></i>История
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Analysis Section -->
            <div x-show="activeTab === 'analyze'" x-cloak class="space-y-8">
                <!-- Model Loading Status -->
                <div x-show="isLoadingModel" class="bg-blue-50 border border-blue-200 rounded-xl p-6 text-center">
                    <div class="loading-bar mb-4">
                        <i class="fas fa-cog fa-spin text-4xl text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">Загрузка AI-модели</h3>
                    <p class="text-blue-600" x-text="loadingProgress"></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                        <div class="bg-blue-600 h-2.5 rounded-full" :style="`width: ${modelLoadProgress}%`"></div>
                    </div>
                </div>

                <!-- Thought Input -->
                <div x-show="!isLoadingModel" class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-edit mr-3 text-blue-500"></i>Введите вашу мысль
                    </h2>
                    <textarea 
                        x-model="userThought"
                        placeholder="Опишите мысль или ситуацию, которую хотите проанализировать. Например: 'Если я не сдам проект идеально, меня уволят'..."
                        class="w-full thought-input p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition"
                        :disabled="isAnalyzing"></textarea>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-6 space-y-4 sm:space-y-0">
                        <div class="text-sm text-gray-500">
                            <span x-text="userThought.length"></span> символов
                        </div>
                        <div class="space-x-4">
                            <button @click="userThought = ''" 
                                    class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                                <i class="fas fa-eraser mr-2"></i>Очистить
                            </button>
                            <button @click="analyzeThought()"
                                    :disabled="!userThought.trim() || isAnalyzing"
                                    :class="!userThought.trim() || isAnalyzing ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'"
                                    class="px-5 py-2.5 text-white font-semibold rounded-lg transition">
                                <i class="fas fa-play mr-2"></i>
                                <span x-text="isAnalyzing ? 'Анализ...' : 'Проанализировать'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analysis Results -->
                <div x-show="results && results.length > 0 && !isAnalyzing" class="bg-white rounded-2xl shadow-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-chart-bar mr-3 text-green-500"></i>Результаты анализа
                        </h2>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <span class="text-sm text-gray-600 mr-2">Порог уверенности:</span>
                                <input type="range" x-model="confidenceThreshold" min="0.1" max="0.9" step="0.05"
                                       class="w-32" @change="filterResults()">
                                <span class="ml-2 font-mono" x-text="(confidenceThreshold * 100).toFixed(0) + '%'"></span>
                            </div>
                            <button @click="saveToHistory()" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-save text-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Summary Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <div class="text-blue-800 font-bold text-2xl" x-text="results.length"></div>
                            <div class="text-blue-600">Обнаружено искажений</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl">
                            <div class="text-green-800 font-bold text-2xl" 
                                 x-text="(results.reduce((max, r) => Math.max(max, r.score), 0) * 100).toFixed(1) + '%'"></div>
                            <div class="text-green-600">Максимальная уверенность</div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-xl">
                            <div class="text-purple-800 font-bold text-2xl" 
                                 x-text="new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})"></div>
                            <div class="text-purple-600">Время анализа</div>
                        </div>
                    </div>

                    <!-- Distortions List -->
                    <div class="space-y-4">
                        <template x-for="(result, index) in results" :key="result.id">
                            <div class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition">
                                <div class="flex justify-between items-center p-4 bg-gray-50">
                                    <div>
                                        <h3 class="font-bold text-lg text-gray-800" x-text="result.name"></h3>
                                        <p class="text-gray-600 text-sm mt-1" x-text="result.description"></p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-blue-700" 
                                             x-text="(result.score * 100).toFixed(1) + '%'"></div>
                                        <div class="text-xs text-gray-500">уверенность</div>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full" 
                                             :style="`width: ${result.score * 100}%`"></div>
                                    </div>
                                    <div class="text-sm text-gray-700" x-text="getExplanation(result.score)"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div x-show="activeTab === 'history'" x-cloak class="bg-white rounded-2xl shadow-xl p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-history mr-3 text-blue-500"></i>История анализов
                </h2>
                
                <div x-show="!history || history.length === 0" class="text-center py-12">
                    <i class="fas fa-clock text-5xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-lg">История анализов пуста</p>
                </div>

                <div x-show="history && history.length > 0" class="space-y-4">
                    <template x-for="(item, index) in history.slice().reverse()" :key="item.id">
                        <div class="border border-gray-200 rounded-xl p-4 hover:bg-gray-50 transition">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-gray-800 mb-2" x-text="item.thought.substring(0, 150) + (item.thought.length > 150 ? '...' : '')"></p>
                                    <div class="flex items-center text-sm text-gray-500">
                                        <i class="far fa-clock mr-1"></i>
                                        <span x-text="new Date(item.timestamp).toLocaleString()"></span>
                                        <span class="mx-2">•</span>
                                        <span x-text="item.results.length + ' искажений'"></span>
                                    </div>
                                </div>
                                <button @click="loadFromHistory(item)" class="text-blue-600 hover:text-blue-800 ml-4">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-3">
                                <template x-for="result in item.results.slice(0, 3)" :key="result.id">
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs rounded-full"
                                          x-text="result.name + ' (' + (result.score * 100).toFixed(0) + '%)'"></span>
                                </template>
                                <span x-show="item.results.length > 3" class="px-3 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                    +ещё <span x-text="item.results.length - 3"></span>
                                </span>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div x-show="history && history.length > 0" class="mt-6 flex justify-between items-center">
                    <button @click="clearHistory()" class="px-4 py-2 text-red-600 hover:text-red-800">
                        <i class="fas fa-trash mr-2"></i>Очистить историю
                    </button>
                    <button @click="exportHistory()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-download mr-2"></i>Экспорт истории
                    </button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-12 border-t border-gray-200">
            <div class="container mx-auto px-4 py-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <div class="flex items-center">
                            <i class="fas fa-brain text-2xl text-blue-600 mr-3"></i>
                            <span class="text-xl font-bold text-gray-800">CognitiveBiasGauge</span>
                        </div>
                        <p class="text-gray-600 text-sm mt-2">AI-powered cognitive bias analyzer</p>
                    </div>
                    
                    <div class="text-center md:text-right">
                        <div class="text-sm text-gray-500 mb-2">
                            <span x-text="modelStatus"></span>
                            <span x-show="backendInfo" class="ml-2" x-text="'• ' + backendInfo"></span>
                        </div>
                        <div class="text-xs text-gray-400">
                            © 2024 • Все вычисления выполняются локально в браузере
                        </div>
                    </div>
                </div>
                
                <!-- Performance Monitoring -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="text-xs text-gray-500 flex flex-wrap justify-center gap-4">
                        <div>
                            <i class="fas fa-microchip mr-1"></i>
                            <span x-text="'Анализов: ' + (performanceStats ? performanceStats.totalAnalyses : 0)"></span>
                        </div>
                        <div x-show="performanceStats && performanceStats.lastAnalysisTime > 0">
                            <i class="fas fa-stopwatch mr-1"></i>
                            <span x-text="'Последний анализ: ' + performanceStats.lastAnalysisTime.toFixed(0) + 'ms'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // Инициализируем глобальную переменную для Alpine.js
        window.cognitiveBiasApp = () => {
            return {
                // Состояния
                activeTab: 'analyze',
                userThought: '',
                isLoadingModel: true,
                isAnalyzing: false,
                modelLoadProgress: 0,
                loadingProgress: 'Инициализация...',
                confidenceThreshold: 0.3,
                model: null,
                biasLibrary: [],
                results: [],
                history: [],
                modelStatus: 'Загрузка модели...',
                backendInfo: 'WebGL',
                
                // Performance monitoring
                performanceStats: {
                    lastAnalysisTime: 0,
                    totalAnalyses: 0
                },
                
                // Кеш эмбеддингов
                embeddingCache: new Map(),
                
                // Инициализация при создании компонента
                async init() {
                    console.log('Инициализация приложения...');
                    
                    // Создаем библиотеку искажений
                    this.biasLibrary = this.createBiasLibrary();
                    
                    // Загружаем историю из localStorage
                    this.loadHistoryFromStorage();
                    
                    // Загружаем модель
                    await this.loadModelWithProgress();
                },
                
                // Function to create bias library
                createBiasLibrary() {
                    return [
                        {
                            id: 1,
                            name: "Всё или ничего",
                            description: "Оценка ситуаций в крайностях, без промежуточных вариантов.",
                            passage: "passage: Дихотомическое мышление, черно-белое мышление, крайности, отсутствие полутонов, все или ничего, всегда или никогда, идеально или провал"
                        },
                        {
                            id: 2,
                            name: "Катастрофизация",
                            description: "Преувеличение негативных последствий событий, ожидание худшего.",
                            passage: "passage: Катастрофизация, преувеличение негатива, ожидание худшего, все рухнет, конец света, ужасные последствия, трагедия"
                        },
                        {
                            id: 3,
                            name: "Обесценивание положительного",
                            description: "Игнорирование или минимизация положительных аспектов ситуации.",
                            passage: "passage: Обесценивание положительного, игнорирование хорошего, минимизация успехов, не замечать позитив, отрицание достижений"
                        },
                        {
                            id: 4,
                            name: "Эмоциональное обоснование",
                            description: "Оценка реальности на основе эмоций, а не фактов.",
                            passage: "passage: Эмоциональное обоснование, чувства вместо фактов, эмоции как доказательство, верить чувствам а не разуму"
                        },
                        {
                            id: 5,
                            name: "Навешивание ярлыков",
                            description: "Категоризация людей или ситуаций на основе единичных событий.",
                            passage: "passage: Навешивание ярлыков, стереотипизация, обобщение по одному случаю, категоризация без оснований"
                        },
                        {
                            id: 6,
                            name: "Преувеличение/преуменьшение",
                            description: "Искажение реальности, чрезмерное усиление негативных аспектов или умаление положительных.",
                            passage: "passage: Преувеличение негатива, преуменьшение позитива, искажение масштабов, увеличение проблем, уменьшение успехов"
                        },
                        {
                            id: 7,
                            name: "Ментальный фильтр",
                            description: "Фокусировка на негативных деталях, игнорирование положительных аспектов.",
                            passage: "passage: Ментальный фильтр, негативный фильтр, замечать только плохое, игнорировать хорошее, выборочное внимание к негативу"
                        },
                        {
                            id: 8,
                            name: "Чтение мыслей",
                            description: "Предположение о мыслях других без достаточных оснований.",
                            passage: "passage: Чтение мыслей, предполагать что думают другие, домыслы о мнениях, приписывание мыслей"
                        },
                        {
                            id: 9,
                            name: "Сверхобобщение",
                            description: "Выводы на основе ограниченного числа примеров, распространение частных случаев на общую картину.",
                            passage: "passage: Сверхобобщение, делать глобальные выводы из частных случаев, обобщение без оснований, экстраполяция"
                        },
                        {
                            id: 10,
                            name: "Персонализация",
                            description: "Восприятие событий как направленных лично против себя, принятие слишком большой ответственности за события.",
                            passage: "passage: Персонализация, принимать на свой счет, винить себя за все, чувствовать себя целью, излишняя ответственность"
                        },
                        {
                            id: 11,
                            name: "Утверждения «мне следует» и «я должен»",
                            description: "Жёсткие требования к себе и окружающим, использование долженствований.",
                            passage: "passage: Долженствование, жесткие требования, я должен, мне следует, перфекционизм, негибкие правила"
                        },
                        {
                            id: 12,
                            name: "Туннельное зрение",
                            description: "Сосредоточение на одной детали в ущерб общему контексту, упущение важной информации.",
                            passage: "passage: Туннельное зрение, узкий фокус, игнорирование контекста, зацикленность на детали, упущение общей картины"
                        }
                    ];
                },
                
                // Model loading function
                async loadModel() {
                    try {
                        // Используем динамический импорт для Transformers.js
                        const { pipeline } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0');
                        
                        // Используем маленькую модель для быстрой загрузки
                        const extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', {
                            quantized: true,
                            revision: 'main'
                        });
                        
                        console.log('Model loaded successfully');
                        return extractor;
                    } catch (error) {
                        console.error('Error loading model:', error);
                        throw error;
                    }
                },
                
                // Model loading with progress
                async loadModelWithProgress() {
                    try {
                        this.loadingProgress = 'Загрузка модели MiniLM...';
                        this.modelLoadProgress = 20;
                        
                        this.model = await this.loadModel();
                        
                        this.modelLoadProgress = 60;
                        this.loadingProgress = 'Подготовка библиотеки искажений...';
                        
                        // Generate embeddings for bias library
                        await this.generateBiasEmbeddings();
                        
                        this.modelLoadProgress = 100;
                        this.loadingProgress = 'Готово!';
                        this.modelStatus = 'Модель загружена ✓';
                        this.isLoadingModel = false;
                        
                    } catch (error) {
                        console.error('Initialization error:', error);
                        this.modelStatus = 'Ошибка загрузки модели';
                        this.loadingProgress = 'Ошибка: ' + error.message;
                        
                        // Если модель не загрузилась, показываем сообщение
                        setTimeout(() => {
                            if (this.isLoadingModel) {
                                this.modelStatus = 'Не удалось загрузить модель';
                                this.loadingProgress = 'Пожалуйста, обновите страницу';
                            }
                        }, 5000);
                    }
                },
                
                // Generate embeddings for bias library
                async generateBiasEmbeddings() {
                    for (let i = 0; i < this.biasLibrary.length; i++) {
                        const bias = this.biasLibrary[i];
                        try {
                            const embedding = await this.model(bias.passage, {
                                pooling: 'mean',
                                normalize: true
                            });
                            
                            // Сохраняем эмбеддинг как обычный массив
                            bias.embedding = Array.from(embedding.data);
                            
                            // Update progress
                            this.modelLoadProgress = 60 + Math.floor((i / this.biasLibrary.length) * 30);
                            this.loadingProgress = `Обработка искажений: ${i + 1}/${this.biasLibrary.length}`;
                            
                        } catch (error) {
                            console.error(`Error generating embedding for ${bias.name}:`, error);
                            // Продолжаем с другими искажениями
                        }
                    }
                },
                
                // Main analysis function
                async analyzeThought() {
                    if (!this.userThought.trim() || !this.model) return;
                    
                    const startTime = performance.now();
                    this.isAnalyzing = true;
                    this.results = [];
                    
                    try {
                        // Кешируем эмбеддинги
                        const cacheKey = this.userThought.toLowerCase().trim();
                        
                        let thoughtEmbedding;
                        if (this.embeddingCache.has(cacheKey)) {
                            thoughtEmbedding = this.embeddingCache.get(cacheKey);
                        } else {
                            // Генерируем эмбеддинг для мысли пользователя
                            const embedding = await this.model(`query: ${this.userThought}`, {
                                pooling: 'mean',
                                normalize: true
                            });
                            
                            thoughtEmbedding = Array.from(embedding.data);
                            this.embeddingCache.set(cacheKey, thoughtEmbedding);
                            
                            // Ограничиваем размер кеша
                            if (this.embeddingCache.size > 50) {
                                const firstKey = this.embeddingCache.keys().next().value;
                                this.embeddingCache.delete(firstKey);
                            }
                        }
                        
                        // Вычисляем сходство со всеми искажениями
                        const matches = [];
                        
                        for (const bias of this.biasLibrary) {
                            if (!bias.embedding) continue;
                            
                            // Вычисляем косинусное сходство между массивами
                            const score = this.cosineSimilarity(thoughtEmbedding, bias.embedding);
                            
                            if (score >= this.confidenceThreshold) {
                                matches.push({
                                    id: bias.id,
                                    name: bias.name,
                                    description: bias.description,
                                    score: score,
                                    rawScore: score
                                });
                            }
                        }
                        
                        // Сортировка по убыванию сходства
                        matches.sort((a, b) => b.score - a.score);
                        this.results = matches;
                        
                        this.performanceStats.lastAnalysisTime = performance.now() - startTime;
                        this.performanceStats.totalAnalyses++;
                        
                        console.log(`Анализ завершен за ${this.performanceStats.lastAnalysisTime.toFixed(2)}мс`);
                        
                    } catch (error) {
                        console.error('Ошибка анализа:', error);
                        this.showError('Ошибка анализа', 'Пожалуйста, попробуйте снова или введите другой текст.');
                    } finally {
                        this.isAnalyzing = false;
                    }
                },
                
                // Косинусное сходство между двумя массивами (чистый JavaScript)
                cosineSimilarity(a, b) {
                    if (a.length !== b.length) {
                        console.error('Размеры векторов не совпадают');
                        return 0;
                    }
                    
                    let dotProduct = 0;
                    let normA = 0;
                    let normB = 0;
                    
                    for (let i = 0; i < a.length; i++) {
                        dotProduct += a[i] * b[i];
                        normA += a[i] * a[i];
                        normB += b[i] * b[i];
                    }
                    
                    if (normA === 0 || normB === 0) {
                        return 0;
                    }
                    
                    return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
                },
                
                // Filter results by threshold
                filterResults() {
                    this.results = this.results.map(r => ({
                        ...r,
                        score: r.rawScore >= this.confidenceThreshold ? r.rawScore : 0
                    })).filter(r => r.score > 0)
                      .sort((a, b) => b.score - a.score);
                },
                
                // Generate explanation based on score
                getExplanation(score) {
                    if (score >= 0.7) {
                        return "Высокая вероятность данного искажения. Рекомендуется критически переосмыслить мысль.";
                    } else if (score >= 0.5) {
                        return "Средняя вероятность. Обратите внимание на возможное влияние этого искажения.";
                    } else {
                        return "Низкая вероятность, но возможно наличие элементов данного искажения.";
                    }
                },
                
                // Save current analysis to history
                saveToHistory() {
                    if (this.results.length === 0) return;
                    
                    const historyItem = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        thought: this.userThought,
                        results: this.results.map(r => ({
                            id: r.id,
                            name: r.name,
                            score: r.score
                        }))
                    };
                    
                    this.history.push(historyItem);
                    
                    // Save to localStorage
                    try {
                        const storedHistory = JSON.parse(localStorage.getItem('cbg_history') || '[]');
                        storedHistory.push(historyItem);
                        localStorage.setItem('cbg_history', JSON.stringify(storedHistory.slice(-50)));
                    } catch (error) {
                        console.error('Error saving to localStorage:', error);
                    }
                    
                    alert('Анализ сохранен в историю!');
                },
                
                // Load history from localStorage
                loadHistoryFromStorage() {
                    try {
                        const storedHistory = JSON.parse(localStorage.getItem('cbg_history') || '[]');
                        this.history = storedHistory;
                    } catch (error) {
                        console.error('Error loading history:', error);
                        this.history = [];
                    }
                },
                
                // Load analysis from history
                loadFromHistory(item) {
                    this.userThought = item.thought;
                    this.results = item.results.map(r => ({
                        ...r,
                        description: this.biasLibrary.find(b => b.id === r.id)?.description || '',
                        rawScore: r.score
                    }));
                    this.activeTab = 'analyze';
                    
                    // Scroll to results
                    setTimeout(() => {
                        const resultsElement = document.querySelector('[x-show*="results.length"]');
                        if (resultsElement) {
                            resultsElement.scrollIntoView({ 
                                behavior: 'smooth' 
                            });
                        }
                    }, 100);
                },
                
                // Clear history
                clearHistory() {
                    if (confirm('Очистить всю историю анализов?')) {
                        this.history = [];
                        localStorage.removeItem('cbg_history');
                    }
                },
                
                // Export history
                exportHistory() {
                    const dataStr = JSON.stringify(this.history, null, 2);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `cognitivebias-history-${new Date().toISOString().split('T')[0]}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                },
                
                // Show error
                showError(title, message) {
                    alert(`${title}: ${message}`);
                },
                
                // Clean up memory
                cleanupMemory() {
                    // Очищаем кеш эмбеддингов
                    this.embeddingCache.clear();
                    alert('Кеш очищен!');
                }
            };
        };
    </script>
</body>
</html>